<html lang="en">
	<head>
		<meta charset="UTF-8">
		<title>MIC</title>
		<script src="modernizr.js"></script>
		<script type="text/javascript">
			window.addEventListener("load", eventWindowLoaded, false);
			
			var Debugger = function() {};
			Debugger.log = function(message) {
				try {
					console.log(message);
				}catch(exception){
					return;
				}
			}
			
			function eventWindowLoaded() {
				canvasApp();
			}
			
			function canvasApp() {
	
				if(!canvasSupport) {
					return;
				}
				
				var theCanvas = document.getElementById("canvasOne");
					
				if(!theCanvas) {
					return;
				}
					
				var context = theCanvas.getContext("2d");
				
				// base frame
				var frameX = 1;
				var frameY = 1;
				var frameWidth = theCanvas.width-2;
				var frameHeight = theCanvas.height-2;
				
				// header
				var headerHeight = 30;
				var headerX = frameX;
				var headerY = frameY;
				var headerWidth = frameWidth;
				
				// footer
				var footerHeight = 30;
				var footerX = frameX;
				var footerY = frameHeight-footerHeight;
				var footerWidth = frameWidth;
				
				// main screen
				var mainScreenX = frameX;
				var mainScreenY = headerY + headerHeight;
				var mainScreenWidth = frameWidth;
				var mainScreenHeight = footerY;
				
				// hour lines
				var maxHourLine = 29;
				var hourLabelY = mainScreenY + 10;
				var hourLineY = mainScreenY + 15;
				var hourLineHeight = mainScreenHeight - 5;
				
				// horizontal zoom
				var maxStepBetweenHourLines = 200;
				
				// horizontal zoom
				var zoomX = 1;
				var zoomXElement = document.getElementById("zoomX");
				zoomXElement.addEventListener("change", function (e) {
						zoomX = e.target.value;
						leftX = 0; // FIXME
						drawScreen();
					},false);
				
				// horizontal scrolling
				var leftX = 0;
				var scrollStep = 10;
				var scrollLeftButton = document.getElementById("scrollLeft");
				scrollLeftButton.addEventListener("click", function (e) {
						if(leftX < 0) {
							leftX += scrollStep;
							drawScreen();
						}
					},false);
				var scrollRightButton = document.getElementById("scrollRight");
				scrollRightButton.addEventListener("click", function (e) {
						if(leftX > mainScreenWidth-(mainScreenWidth*zoomX)) {
							leftX -= scrollStep;
							drawScreen();
						}
					},false);
				
				drawScreen();
				
				function drawScreen() {
				
					
					
					cleanFrame();
					
					drawBackground();
					
					function drawBackground() {
						context.strokeStyle = "black";
						drawFrame();
						drawHeader();
						drawFooter();

						context.translate(leftX,0);
						
						var hourLineXs = calculateHourLineXs();
						for(var i=0; i<hourLineXs.length; i++) {
							if(i < maxHourLine) {
								drawHourLabel(hourLineXs[i],getHourLabel(i+1));
								drawHourLine(hourLineXs[i]);
							}
						}
					}
					
					function cleanFrame() {
						context.setTransform(1,0,0,1,0,0);
						context.clearRect(frameX,frameY,frameWidth,frameHeight);
						context.strokeStyle = "black";
						context.lineWidth = 1;
						context.setLineDash([0]);
					}
					
					function drawFrame() {
						context.strokeRect(frameX,frameY,frameWidth,frameHeight);
					}
					
					function drawHeader() {
						context.strokeRect(headerX,headerY,headerWidth,headerHeight);
					}
					
					function drawFooter() {
						context.strokeRect(footerX,footerY,footerWidth,footerHeight+2); //+2 or the line seems blurred
					}
					
					function drawHourLine(x) {
						context.strokeStyle = "black";
						context.lineWidth = .5;
						context.setLineDash([10,3]);
						context.beginPath();
						context.moveTo(x, hourLineY);
						context.lineTo(x, hourLineHeight);
						context.stroke();
						context.closePath();
					}
					
					function drawHourLabel(x,hour) {
						context.font = "10px serif"
						context.fillStyle = "black";
						var metrics = context.measureText(hour);
						var textWidth = metrics.width;
						context.fillText (hour, x-textWidth/2, hourLabelY);
					}
					
					function calculateHourLineXs() {
						var hourLineXs = new Array();
						
						var i = 0;
						var tempX;
						var step = calculateHourLineStep(maxHourLine+1);
						for(var x=step; x<(mainScreenWidth*zoomX); x+=step) {
							tempX = Math.floor(x) + .5; //to avoid blurred lines
							hourLineXs[i] = tempX;
							i++;
						}
						
						return hourLineXs;
					}
					
					function calculateHourLineStep(numberOfSections) {
						var step = (mainScreenWidth*zoomX)/numberOfSections;
						// TODO
						//if(step > maxStepBetweenHourLines) {
						//	step = calculateHourLineStep(numberOfSections*2);
						//}
						return step;
					}
					
					function getHourLabel(hour) {
						var label = "";
						if(hour < 10) {
							label += "0";
						}
						label += hour;
						label += ":00";
						return label;
					}
				}
				
				function canvasSupport() {
					return Modernizr.canvas;
				}
				
			}
		</script>
	</head>
	<body>
		<div>
			<canvas id="canvasOne" width="1300" height="600">
			Your browser doesn't support HTML5 Canvas!
			</canvas>
		</div>
		<input id="zoomX" type ="range" min="1" max="10" step="0.1" value="1" style="width: 400px" />
		<input id="scrollLeft" type="button" value="<<" />
		<input id="scrollRight" type="button" value=">>" />
	</body>
</html>